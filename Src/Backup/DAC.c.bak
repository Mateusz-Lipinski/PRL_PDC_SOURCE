#include "usart.h"
#include <stdio.h>
#include "state.h"
#include "spi.h"
#include "DAC.h"
#include "usart_utils.h"
#include "main.h"

extern state State;

void DAC_SPI_WRITE_24(uint32_t data)
{
    uint8_t txbuffer[3] = {
        (uint8_t)((data & 0xff0000) >> 16),
        (uint8_t)((data & 0xff00) >> 8),
        (uint8_t)((data & 0xff))};
    HAL_SPI_Transmit(&hspi1, txbuffer, 3, HAL_MAX_DELAY);
}

void DAC_TEST()
{
    for (int i = 0; i <= 0xfff; i += 1)
    {
        DAC_SPI_WRITE_24(DAC_WRITE_AND_UPDATE + DAC_CH(1) + i);
        SERIAL_WRITE("%i\n", i)
        HAL_GPIO_WritePin(DAC_nLOAD_GPIO_Port, DAC_nLOAD_Pin, 0);
        HAL_Delay(1);
        HAL_GPIO_WritePin(DAC_nLOAD_GPIO_Port, DAC_nLOAD_Pin, 1);
    }
}