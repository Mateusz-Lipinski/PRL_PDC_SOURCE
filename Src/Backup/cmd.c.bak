#include "usart.h"
#include <stdio.h>
#include "state.h"
#include "usart_utils.h"
#include "ADC.h"

extern uint8_t COMMAND;

uint8_t cmd()
{
    switch (COMMAND)
    {
    case cmd_blink:
    {
        COMMAND = 0;
        SERIAL_WRITE("ok\n");
        for (int i = 0; i < 10; i++)
        {
            HAL_GPIO_TogglePin(LED_PHASE_GPIO_Port, LED_PHASE_Pin);
            HAL_Delay(100);
        }
        return 0;
    }
    case cmd_adc_id:
    {
        SERIAL_WRITE("%x\n", ADC_ID());
        COMMAND = 0;
        return 0;
    }
    case cmd_adc_reset:
    {
        SERIAL_WRITE("ADC RESET\n");
        ADC_reset();
        COMMAND = 0;
        return 0;
    }
    case cmd_adc_debug:
    {
        SERIAL_WRITE("ADC DEBUG:\n");
        ADC_CMD(ADC_READ, ADC_STATUS_REG);
        SERIAL_WRITE("\tADC_STATUS_REG:\t%x\n", ADC_SPI_READ_8());
        SERIAL_WRITE("\tADC_STATUS_REG:\t%x\n", ADC_SPI_READ_8());

        COMMAND = 0;
        return 0;
    }
    case cmd_undefined:
    {
        COMMAND = 0;
        SERIAL_WRITE("undefined\n");
        HAL_GPIO_TogglePin(LED_PHASE_GPIO_Port, LED_PHASE_Pin);
        HAL_Delay(100);
        HAL_GPIO_TogglePin(LED_PHASE_GPIO_Port, LED_PHASE_Pin);
        HAL_Delay(100);
        return 0;
    }
    default:
    {
        return 0;
    }
    }
}
